generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Salon {
  id                String            @id @default(uuid())
  name              String
  slug              String            @unique
  type              String            @default("Барбершоп")
  description       String?
  phone             String?
  email             String?
  address           String?
  shortAddress      String?
  latitude          Float?
  longitude         Float?
  logo              String?
  photos            String[]          @default([])
  workingHours      Json?
  amenities         String[]          @default([])
  timezone          String            @default("Europe/Kiev")
  currency          String            @default("UAH")
  bufferTime        Int               @default(0)   // Авто-буфер між записами (хвилини)
  rating            Float             @default(5.0)
  reviewCount       Int               @default(0)
  isActive          Boolean           @default(true)
  ownerId           String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  paletteId         String            @default("earth-harmony")
  previousPlatform  String?           // Платформа з якої мігрують (altegio, booksy, fresha...)
  onboardingData      Json?             // Дані онбордінгу: accountType, serviceLocation, website, lastStep
  onboardingCompleted Boolean           @default(false)
  migrationDismissed Boolean         @default(false) // Чи закрив користувач банер міграції
  customBotToken    String?           // White-label Telegram bot token
  customBotUsername String?           // White-label Telegram bot username
  googlePlaceId     String?           // Google Business Profile place ID

  // ── Booking rules ──
  minLeadTimeHours    Int       @default(2)      // Мін. час до запису (години)
  maxAdvanceDays      Int       @default(30)     // Макс. наперед (дні)
  slotStepMinutes     Int       @default(30)     // Крок слотів (хвилини)
  requireConfirmation Boolean   @default(false)  // Потрібне підтвердження власником
  bookingWarningText  String?                    // Текст-попередження при бронюванні

  // ── Cancellation policy ──
  cancelDeadlineHours   Int     @default(4)      // За скільки годин можна скасувати
  noShowPenaltyPercent  Int     @default(0)      // Штраф за no-show (%)
  maxNoShowsBeforeBlock Int     @default(3)      // No-show до автоблокування

  // ── Notification settings ──
  notifyChannels        String[] @default(["telegram", "email"])  // Канали сповіщень
  notifyReminder24h     Boolean  @default(true)   // Нагадування за 24 год
  notifyReminder2h      Boolean  @default(true)   // Нагадування за 2 год
  notifyReminder1h      Boolean  @default(false)  // Нагадування за 1 год
  notifyAfterVisit      Boolean  @default(true)   // Подяка після візиту
  notifyBirthday        Boolean  @default(false)  // Привітання з ДН
  notifyReturnDays      Int      @default(0)      // Повернення клієнтів (0 = вимкнено)
  bookings          Booking[]
  clients           Client[]
  masters           Master[]
  products          Product[]
  productCategories ProductCategory[]
  reviews           Review[]
  services          Service[]
  categories        ServiceCategory[]
  users             User[]
  subscription      Subscription?

  @@index([slug])
  @@index([isActive])
}

model User {
  id                   String   @id @default(uuid())
  email                String   @unique
  passwordHash         String
  name                 String?
  phone                String?
  avatar               String?
  role                 UserRole @default(SALON_OWNER)
  salonId              String?
  telegramChatId       String?
  telegramId           String?  @unique
  telegramUsername     String?
  notificationsEnabled Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  salon                Salon?   @relation(fields: [salonId], references: [id])
  otpCodes             OtpCode[]

  @@index([email])
  @@index([salonId])
  @@index([telegramId])
}

model Master {
  id            String          @id @default(uuid())
  salonId       String
  name          String
  role          String?
  phone         String?
  email         String?         @unique
  avatar        String?
  bio           String?
  color         String?
  rating        Float           @default(5.0)
  reviewCount   Int             @default(0)
  price         Int             @default(0)
  workingHours  Json?
  lunchDuration Int             @default(60)  // Тривалість обіду в хвилинах
  lunchStart    String          @default("13:00") // Час початку обіду (HH:mm)
  timezone      String          @default("Europe/Kiev") // Копіюється з салону при створенні
  isActive      Boolean         @default(true)
  sortOrder     Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lastLogin     DateTime?
  passwordHash  String?
  bookings     Booking[]
  salon        Salon           @relation(fields: [salonId], references: [id], onDelete: Cascade)
  services     MasterService[]
  reviews        Review[]
  timeBlocks     TimeBlock[]
  trustedDevices TrustedDevice[]
  staffOtps      StaffOtp[]

  @@index([salonId])
  @@index([isActive])
}

model ServiceCategory {
  id        String    @id @default(uuid())
  salonId   String
  name      String
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  services  Service[]
  salon     Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
}

model Service {
  id              String           @id @default(uuid())
  salonId         String
  categoryId      String?
  name            String
  description     String?
  price           Int
  priceFrom       Boolean          @default(false)
  duration        Int              @default(30)
  isActive        Boolean          @default(true)
  sortOrder       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bookings        Booking[]
  masters         MasterService[]
  category        ServiceCategory? @relation(fields: [categoryId], references: [id])
  salon           Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade)
  serviceProducts ServiceProduct[]

  @@index([salonId])
  @@index([categoryId])
}

model MasterService {
  id             String  @id @default(uuid())
  masterId       String
  serviceId      String
  customPrice    Int?
  customDuration Int?
  master         Master  @relation(fields: [masterId], references: [id], onDelete: Cascade)
  service        Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([masterId, serviceId])
  @@index([masterId])
  @@index([serviceId])
}

model Client {
  id               String    @id @default(uuid())
  salonId          String
  name             String
  phone            String
  email            String?
  visitsCount      Int       @default(0)
  totalSpent       Int       @default(0)
  lastVisit        DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  telegramChatId   String?
  telegramUsername String?
  birthday         DateTime?          // Дата народження
  isBlocked        Boolean   @default(false)  // Чорний список
  blockReason      String?            // Причина блокування
  noShowCount      Int       @default(0)      // Лічильник no-show
  bookings         Booking[]
  salon            Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  reviews          Review[]

  @@unique([salonId, phone])
  @@index([salonId])
  @@index([phone])
  @@index([telegramChatId])
}

model Booking {
  id               String        @id @default(uuid())
  salonId          String
  clientId         String?
  masterId         String?
  serviceId        String?
  clientName       String
  clientPhone      String
  clientEmail      String?
  serviceName      String?
  masterName       String?
  date             String
  time             String
  timeEnd          String?
  duration         Int           @default(60)
  extraTime        Int           @default(0)   // Додатковий час (для клієнтів що люблять поговорити)
  price            Int           @default(0)
  status           BookingStatus @default(CONFIRMED)
  notes            String?
  notificationSent Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  client           Client?       @relation(fields: [clientId], references: [id])
  master           Master?       @relation(fields: [masterId], references: [id])
  salon            Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  service          Service?      @relation(fields: [serviceId], references: [id])
  review           Review?

  @@index([salonId])
  @@index([masterId])
  @@index([clientId])
  @@index([date])
  @@index([status])
}

model StaffInvitation {
  id          String    @id @default(uuid())
  salonId     String
  email       String
  name        String?
  role        String?
  token       String    @unique @default(uuid())
  isUsed      Boolean   @default(false)
  expiresAt   DateTime
  masterId    String?   @unique
  createdAt   DateTime  @default(now())
  emailSentAt DateTime?
  viewedAt    DateTime?

  @@index([token])
  @@index([email])
  @@index([salonId])
}

model AuditLog {
  id         String      @id @default(uuid())
  salonId    String
  actorType  String
  actorId    String?
  actorName  String?
  action     AuditAction
  entityType String
  entityId   String?
  entityName String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  @@index([salonId])
  @@index([actorId])
  @@index([entityType])
  @@index([createdAt])
}

model Notification {
  id            String   @id @default(uuid())
  salonId       String
  recipientType String
  recipientId   String?
  type          String
  title         String
  message       String
  entityType    String?
  entityId      String?
  isRead        Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([salonId])
  @@index([recipientId])
  @@index([isRead])
  @@index([createdAt])
}

model ReminderSettings {
  id          String   @id @default(uuid())
  salonId     String   @unique
  reminder24h Boolean  @default(true)
  reminder2h  Boolean  @default(true)
  template24h String?
  template2h  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([salonId])
}

model SentReminder {
  id           String   @id @default(uuid())
  bookingId    String
  type         String
  channel      String
  status       String   @default("sent")
  errorMessage String?
  sentAt       DateTime @default(now())

  @@unique([bookingId, type])
  @@index([bookingId])
  @@index([sentAt])
}

model ProductCategory {
  id        String    @id @default(uuid())
  salonId   String
  name      String
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  products  Product[]
  salon     Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
}

model Product {
  id              String           @id @default(uuid())
  salonId         String
  categoryId      String?
  name            String
  description     String?
  sku             String?
  barcode         String?
  costPrice       Int              @default(0)
  sellPrice       Int              @default(0)
  quantity        Int              @default(0)
  minQuantity     Int              @default(0)
  unit            String           @default("шт")
  image           String?
  isActive        Boolean          @default(true)
  sortOrder       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  category        ProductCategory? @relation(fields: [categoryId], references: [id])
  salon           Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade)
  serviceProducts ServiceProduct[]
  movements       StockMovement[]

  @@unique([salonId, sku])
  @@index([salonId])
  @@index([categoryId])
}

model StockMovement {
  id        String            @id @default(uuid())
  salonId   String
  productId String
  type      StockMovementType
  quantity  Int
  costPrice Int?
  sellPrice Int?
  bookingId String?
  note      String?
  actorType String?
  actorId   String?
  actorName String?
  createdAt DateTime          @default(now())
  product   Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

model ServiceProduct {
  id        String  @id @default(uuid())
  serviceId String
  productId String
  quantity  Int     @default(1)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, productId])
  @@index([serviceId])
  @@index([productId])
}

model Review {
  id            String   @id @default(uuid())
  salonId       String
  clientId      String?
  masterId      String?
  bookingId     String?  @unique
  authorName    String
  authorInitial String
  authorColor   String   @default("bg-blue-500")
  rating        Int
  text          String?
  serviceName   String?
  isVisible     Boolean  @default(true)
  createdAt     DateTime @default(now())
  booking       Booking? @relation(fields: [bookingId], references: [id])
  client        Client?  @relation(fields: [clientId], references: [id])
  master        Master?  @relation(fields: [masterId], references: [id])
  salon         Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([masterId])
  @@index([rating])
}

model TimeBlock {
  id        String        @id @default(uuid())
  salonId   String
  masterId  String?
  date      String        // YYYY-MM-DD
  startTime String        // HH:mm
  endTime   String        // HH:mm
  title     String?       // Обід, Перерва, Вихідний...
  type      TimeBlockType @default(BREAK)
  isAllDay  Boolean       @default(false)
  repeat    String?       // daily, weekly, none
  color     String?
  createdAt DateTime      @default(now())
  master    Master?       @relation(fields: [masterId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([masterId])
  @@index([date])
}

model StaffOtp {
  id        String   @id @default(uuid())
  masterId  String
  code      String   // 6-digit code
  expiresAt DateTime
  attempts  Int      @default(0) // failed verification attempts
  used      Boolean  @default(false)
  channel   String   @default("email") // "email" | "telegram"
  createdAt DateTime @default(now())
  master    Master   @relation(fields: [masterId], references: [id], onDelete: Cascade)

  @@index([masterId])
  @@index([expiresAt])
}

model TrustedDevice {
  id           String   @id @default(uuid())
  masterId     String
  fingerprint  String   // hash of User-Agent + screen info
  label        String?  // "Chrome on Android", "Safari on iPhone"
  ip           String?  // last known IP
  lastUsedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  master       Master   @relation(fields: [masterId], references: [id], onDelete: Cascade)

  @@unique([masterId, fingerprint])
  @@index([masterId])
}

enum TimeBlockType {
  BREAK      // Перерва
  LUNCH      // Обід
  DAY_OFF    // Вихідний
  VACATION   // Відпустка
  OTHER      // Інше
}

enum UserRole {
  SUPER_ADMIN
  SALON_OWNER
  MASTER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  WRITE_OFF
  SERVICE
}

enum OtpType {
  REGISTER
  LOGIN
  LINK_TELEGRAM
}

enum OtpChannel {
  SMS
  TELEGRAM
  EMAIL
}

model OtpCode {
  id        String     @id @default(uuid())
  userId    String?
  phone     String     @default("")
  email     String     @default("")
  code      String     // 6 цифр
  type      OtpType
  channel   OtpChannel
  expiresAt DateTime
  verified  Boolean    @default(false)
  attempts  Int        @default(0)
  createdAt DateTime   @default(now())
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

model Subscription {
  id            String    @id @default(uuid())
  salonId       String    @unique
  plan          String    @default("free") // free | pro | business
  status        String    @default("active") // active | cancelled | past_due
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt   DateTime?
  paymentMethod String?   // liqpay | monobank | manual
  externalId    String?   // payment provider subscription id
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  salon         Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
}

// ── Admin: Content pages (terms, privacy, faq) ──
model ContentPage {
  id        String   @id @default(uuid())
  slug      String   @unique // terms, privacy, faq, about
  title     String
  content   String   @db.Text
  isPublished Boolean @default(true)
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── Admin: Promo codes ──
model PromoCode {
  id            String    @id @default(uuid())
  code          String    @unique
  description   String?
  discountType  String    @default("percent") // percent | fixed | trial_days
  discountValue Int       @default(0)         // 20 = 20% or 20₴ or 20 days
  maxUses       Int       @default(0)         // 0 = unlimited
  usedCount     Int       @default(0)
  validFrom     DateTime  @default(now())
  validUntil    DateTime?
  targetPlan    String?                       // pro | business | null=any
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([code])
}

// ── Admin: Feature flags ──
model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique // e.g. "reviews", "analytics", "custom_bot"
  name        String                       // Human readable: "Відгуки"
  description String?
  enabled     Boolean  @default(false)     // Global default
  salonIds    String[] @default([])        // Specific salons (override)
  rolloutPct  Int      @default(0)         // Gradual rollout %
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
