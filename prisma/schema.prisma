// Booking Platform - Prisma Schema
// Style: Fresha-like booking platform for salons/barbershops

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  SALON_OWNER
  MASTER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== SALON ====================

model Salon {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  type        String   @default("Барбершоп")
  description String?

  // Contact info
  phone       String?
  email       String?

  // Address
  address      String?
  shortAddress String?
  
  // Map coordinates
  latitude    Float?
  longitude   Float?

  // Branding
  logo        String?
  photos      String[] @default([])

  // Working hours (JSON for flexibility)
  workingHours Json?

  // Features/amenities
  amenities   String[] @default([])

  // Settings
  timezone    String   @default("Europe/Kiev")
  currency    String   @default("UAH")

  // Stats (denormalized for performance)
  rating      Float    @default(5.0)
  reviewCount Int      @default(0)

  // Status
  isActive    Boolean  @default(true)

  // Owner
  ownerId     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  masters     Master[]
  services    Service[]
  categories  ServiceCategory[]
  clients     Client[]
  bookings    Booking[]
  reviews     Review[]

  @@index([slug])
  @@index([isActive])
}

// ==================== USER ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String

  name          String?
  phone         String?
  avatar        String?

  role          UserRole  @default(SALON_OWNER)

  salonId       String?
  salon         Salon?    @relation(fields: [salonId], references: [id], onDelete: SetNull)

  // Telegram for notifications
  telegramChatId       String?
  notificationsEnabled Boolean @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([salonId])
}

// ==================== MASTER ====================

model Master {
  id              String   @id @default(uuid())

  salonId         String
  salon           Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  name            String
  role            String?  // "Барбер", "Стиліст"
  phone           String?
  email           String?  @unique
  avatar          String?
  bio             String?
  
  // Auth (for staff login)
  passwordHash    String?
  lastLogin       DateTime?

  // Stats
  rating          Float    @default(5.0)
  reviewCount     Int      @default(0)

  // Base price (for display)
  price           Int      @default(0)

  // Working hours (JSON, overrides salon if set)
  workingHours    Json?

  // Status
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  services        MasterService[]
  bookings        Booking[]
  reviews         Review[]

  @@index([salonId])
  @@index([isActive])
}

// ==================== SERVICES ====================

model ServiceCategory {
  id              String   @id @default(uuid())

  salonId         String
  salon           Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  name            String
  sortOrder       Int      @default(0)

  services        Service[]

  createdAt       DateTime @default(now())

  @@index([salonId])
}

model Service {
  id              String   @id @default(uuid())

  salonId         String
  salon           Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  categoryId      String?
  category        ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  name            String
  description     String?

  // Pricing
  price           Int
  priceFrom       Boolean  @default(false)

  // Duration in minutes
  duration        Int      @default(30)

  // Status
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  masters         MasterService[]
  bookings        Booking[]

  @@index([salonId])
  @@index([categoryId])
}

model MasterService {
  id          String   @id @default(uuid())

  masterId    String
  master      Master   @relation(fields: [masterId], references: [id], onDelete: Cascade)

  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Custom pricing/duration for this master
  customPrice    Int?
  customDuration Int?

  @@unique([masterId, serviceId])
  @@index([masterId])
  @@index([serviceId])
}

// ==================== CLIENTS ====================

model Client {
  id              String   @id @default(uuid())

  salonId         String
  salon           Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  name            String
  phone           String
  email           String?

  // Stats
  visitsCount     Int      @default(0)
  totalSpent      Int      @default(0)
  lastVisit       DateTime?

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  bookings        Booking[]
  reviews         Review[]

  @@unique([salonId, phone])
  @@index([salonId])
  @@index([phone])
}

// ==================== BOOKINGS ====================

model Booking {
  id              String   @id @default(uuid())

  salonId         String
  salon           Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  masterId        String?
  master          Master?  @relation(fields: [masterId], references: [id], onDelete: SetNull)

  serviceId       String?
  service         Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  // Client info (denormalized for history)
  clientName      String
  clientPhone     String
  clientEmail     String?

  // Service info (denormalized)
  serviceName     String?
  masterName      String?

  // Time
  date            String   // "2024-01-15"
  time            String   // "14:00"
  timeEnd         String?  // "15:00"
  duration        Int      @default(60)

  // Price at time of booking
  price           Int      @default(0)

  // Status
  status          BookingStatus @default(CONFIRMED)

  // Notes
  notes           String?

  // Notification
  notificationSent Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  review          Review?

  @@index([salonId])
  @@index([masterId])
  @@index([clientId])
  @@index([date])
  @@index([status])
}

// ==================== STAFF INVITATIONS ====================

model StaffInvitation {
  id              String   @id @default(uuid())
  
  salonId         String
  
  email           String
  name            String?
  role            String?  // "Барбер", "Стиліст"
  
  // Invitation token (for URL)
  token           String   @unique @default(uuid())
  
  // Status
  isUsed          Boolean  @default(false)
  expiresAt       DateTime
  
  // When accepted, links to master
  masterId        String?  @unique
  
  createdAt       DateTime @default(now())
  
  @@index([token])
  @@index([email])
  @@index([salonId])
}

// ==================== AUDIT LOG ====================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

model AuditLog {
  id              String   @id @default(uuid())
  
  salonId         String
  
  // Who made the change
  actorType       String   // "admin", "master", "system"
  actorId         String?  // User.id or Master.id
  actorName       String?  // Display name
  
  // What changed
  action          AuditAction
  entityType      String   // "booking", "service", "master", "client", etc.
  entityId        String?
  entityName      String?  // Display name of entity
  
  // Change details (JSON)
  changes         Json?    // { field: { old: x, new: y } }
  
  // IP and metadata
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  @@index([salonId])
  @@index([actorId])
  @@index([entityType])
  @@index([createdAt])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id              String   @id @default(uuid())
  
  salonId         String
  
  // Recipient
  recipientType   String   // "admin", "master"
  recipientId     String?
  
  // Content
  type            String   // "new_booking", "booking_cancelled", "reminder"
  title           String
  message         String
  
  // Related entity
  entityType      String?
  entityId        String?
  
  // Status
  isRead          Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  @@index([salonId])
  @@index([recipientId])
  @@index([isRead])
  @@index([createdAt])
}

// ==================== REVIEWS ====================

model Review {
  id              String   @id @default(uuid())

  salonId         String
  salon           Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  masterId        String?
  master          Master?  @relation(fields: [masterId], references: [id], onDelete: SetNull)

  bookingId       String?  @unique
  booking         Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  // Author info (for display)
  authorName      String
  authorInitial   String
  authorColor     String   @default("bg-blue-500")

  rating          Int      // 1-5
  text            String?
  serviceName     String?

  isVisible       Boolean  @default(true)

  createdAt       DateTime @default(now())

  @@index([salonId])
  @@index([masterId])
  @@index([rating])
}
